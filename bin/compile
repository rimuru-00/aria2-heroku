#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

echo "-----> Install aria2c"
BUILD_DIR=$1

echo "====== DEBUGGING: Exploring directory structure ======" | indent
echo "BUILD_DIR = $BUILD_DIR" | indent
echo "" | indent
echo "Current directory: $(pwd)" | indent
echo "" | indent

# Check if aria2-heroku directory exists
ARIA2_HEROKU_DIR="$BUILD_DIR/aria2-heroku"
if [ -d "$ARIA2_HEROKU_DIR" ]; then
  echo "Contents of aria2-heroku directory:" | indent
  echo "" | indent
  
  # List directories in aria2-heroku
  for dir in $(find $ARIA2_HEROKU_DIR -type d | sort); do
    echo "Directory: $dir" | indent
    echo "  Files:" | indent
    find $dir -maxdepth 1 -type f -exec basename {} \; | sed 's/^/    /' | indent
    echo "" | indent
  done
else
  echo "aria2-heroku directory not found at $ARIA2_HEROKU_DIR" | indent
fi

echo "" | indent
echo "Looking for aria2 tar.bz2 file in BUILD_DIR:" | indent
find $BUILD_DIR -maxdepth 1 -name "aria2*.tar.bz2" -type f | indent
echo "====== END DEBUGGING ======" | indent
echo "" | indent

VENDOR_DIR="vendor"
FILE="aria2-1.37.0-linux-gnu-64bit-build1"

# Look for the aria2 file in BUILD_DIR root
ARIA2_FILE=$(find $BUILD_DIR -maxdepth 1 -name "aria2*.tar.bz2" -type f | head -n 1)

if [ -z "$ARIA2_FILE" ]; then
  echo "ERROR: aria2 tar.bz2 file not found in BUILD_DIR root!" | indent
  exit 1
fi

echo "Found aria2 file at: $ARIA2_FILE" | indent

# Create the vendor directory structure
mkdir -p $BUILD_DIR/$VENDOR_DIR/aria2c
cd $BUILD_DIR/$VENDOR_DIR/aria2c

# Copy the file to current directory
cp $ARIA2_FILE .
ARIA2_FILENAME=$(basename $ARIA2_FILE)

echo "Extracting $ARIA2_FILENAME" | indent
tar jxf $ARIA2_FILENAME
mv $FILE/* .
rm -rf $FILE $ARIA2_FILENAME

echo "exporting PATH" | indent
PROFILE_PATH="$BUILD_DIR/.profile.d/aria2c.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:${HOME}/vendor/aria2c"' >> $PROFILE_PATH

echo "Installation complete!" | indent
